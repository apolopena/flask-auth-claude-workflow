{% extends "base.html" %}

{% block title %}Login - Flask Auth{% endblock %}

{% block content %}
<article>
    <h1>Login</h1>
    <p>Enter your credentials to access your account</p>

    <form id="login-form">
        <div class="form-group">
            <label for="email">Email Address</label>
            <input
                type="email"
                id="email"
                name="email"
                placeholder="you@example.com"
                required
                autocomplete="email"
            >
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input
                type="password"
                id="password"
                name="password"
                placeholder="Enter your password"
                required
                autocomplete="current-password"
            >
        </div>

        <button type="submit" id="submit-btn">Login</button>
    </form>

    <p class="text-center mt-2">
        <a href="{{ url_for('frontend.forgot_password_page') }}" class="text-link">Forgot password?</a>
    </p>

    <p class="text-center mt-2">
        Don't have an account?
        <a href="{{ url_for('frontend.register_page') }}" class="text-link">Register here</a>
    </p>
</article>
{% endblock %}

{% block scripts %}
<script>
    async function resendVerification(email) {
        try {
            const response = await apiCall('/auth/resend-verification', {
                method: 'POST',
                body: JSON.stringify({ email: email })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(data.message, 'success');
            } else {
                showMessage(data.error || 'Failed to resend verification email', 'error');
            }
        } catch (error) {
            showMessage('Network error. Please try again.', 'error');
            console.error('Resend verification error:', error);
        }
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        // Client-side validation
        if (!email || !password) {
            showMessage('Please fill in all fields', 'error');
            return;
        }

        // Set loading state
        setButtonLoading(submitBtn, true);

        try {
            const response = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                // Store tokens in localStorage
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);

                // Store user email for dashboard display
                if (data.user && data.user.email) {
                    localStorage.setItem('user_email', data.user.email);
                }

                // Redirect to dashboard
                window.location.href = '/dashboard';
            } else if (response.status === 403 && data.action === 'resend_verification') {
                // Unverified email - show special error with resend option
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message error';
                errorDiv.innerHTML = `
                    <p>${data.error}</p>
                    <button onclick="resendVerification('${data.email}')">Resend Verification Email</button>
                `;
                const article = document.querySelector('article');
                const existingError = article.querySelector('.message.error');
                if (existingError) {
                    existingError.remove();
                }
                article.insertBefore(errorDiv, article.firstChild);
            } else {
                // Show error message from API
                showMessage(data.error || 'Login failed', 'error');
            }
        } catch (error) {
            showMessage('Network error. Please try again.', 'error');
            console.error('Login error:', error);
        } finally {
            setButtonLoading(submitBtn, false);
        }
    });
</script>
{% endblock %}
